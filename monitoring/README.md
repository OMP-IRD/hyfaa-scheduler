# Monitoring stack, for dev/testing purposes

The monitoring functionalities added to HYFAA processes rely on the **Prometheus** stack.

To collect metrics generated by scripts, the Prometheus ecosystem offers the **Pushgateway**, which is a small service 
to which one can push 
the metrics. That are then available for scraping by the main Prometheus app.

This docker composition supports runs the necessary elements to check the full alerts management:
- the pushgateway to receive the metrics (visible when running at http://localhost:9091/metrics)
- Prometheus itself to collect the metrics and apply alerting rules on it (http://localhost:9090/alerts)
- alertmanager, that manages the alerts and sends notifications (http://localhost:9093/#/alerts)

_This is not a composition aimed at production use, although it can serve as a basis for setting up one._

This configuration does not send email notifications, as it would imply configuring SMTP credentials on code stored in 
a repo (and not really necessary in this scope)

## Why monitoring ?
We have noticed that the preprocesses in particular may fail on a regular basis. They depend on external
services, that might not be available or change their API. 
This blocks the entire processing and prevents the MGB runs to get up-to-date.

By monitoring the execution of the processes, it is possible to set up some alerts based on, for instance,
the last successful run. A last successful run older than 28h will raise suspicion, when expected to run every day.

## Run the compo

```bash
docker compose up
```
- The pushgateway metrics will be then accessible at http://localhost:9091/metrics
- Prometheus web interface at http://localhost:9090
- Alertmanager web interface at http://localhost:9093/#/alerts

Note that the configuration of the alerts is done on the configuration files (prometheus/alerts_rules.yml), not 
on the web interface.

## Activate the monitoring in the processes
The process expects a `PROM_PUSHGATEWAY_URL` environment variable. Set it to `http://localhost:9091`.   
Using the commandline on linux: 
```bash
export PROM_PUSHGATEWAY_URL=http://localhost:9091
```

As an alternative, you can also just write the metrics into a text file, by setting
```bash
export PROM_METRICS_TEXTFILE=/tmp/hyfaa_preprocessing_metrics.txt
```
but this won't propagate to Prometheus or the alertmanager.

If one of those environment variables is set, the metrics will be automatically written.
You can check by looking for the `app="hyfaa"` string on the metrics.
