# Monitoring stack, for dev/testing purposes

The monitoring functionalities added to HYFAA processes rely on the **Prometheus** stack.

To collect metrics generated by scripts, the Prometheus ecosystem offers the **Pushgateway**, which is a small service to which one can push 
the metrics. That are then available for scraping by the main Prometheus app.

This docker composition supports running the full stack, but actually for now only runs the pushgateway,
since this is sufficient for our immediate dev/testing needs: check that the metrics are indeed pushed to the
pushgateway.  
_This is not a composition aimed at production use._

## Why monitoring ?
We have noticed that the preprocesses in particular may fail on a regular basis. They depend on external
services, that might not be available or change their API. 
This blocks the entire processing and prevents the MGB runs to get up-to-date.

By monitoring the execution of the processes, it is possible to set up some alerts based on, for instance,
the last successful run. A last successful run older than 28h will raise suspicion, when expected to run every day.

## Run the compo

```bash
docker compose up
```
The pushgateway will be then accessible at http://localhost:9091/metrics

## Activate the monitoring in the processes
The process expects a `PROM_PUSHGATEWAY_URL` environment variable. Set it to `http://localhost:9091`.   
Using the commandline on linux: 
```bash
export PROM_PUSHGATEWAY_URL=http://localhost:9091
```

As an alternative, you can also just write the metrics into a text file, by setting
```bash
export PROM_METRICS_TEXTFILE=/tmp/hyfaa_preprocessing_metrics.txt
```

If one of those environment variables is set, the metrics will be automatically written.
You can check by looking for the `app="hyfaa"` string on the metrics.
